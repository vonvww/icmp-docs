# docker 部署 #

> 将三台配置文件内容拷贝至对应服务器上,三台服务器执行以下命令：

```
cd /opt/docker/ihos/
docker-compose up -d
```

## MySQL主从配置 ##

### 在主库上执行 ###

- 连接主库
`mysql -h 192.168.1.102 -P 33306 -p`

- 创建连接用户
```
GRANT REPLICATION SLAVE ON *.* to 'mylink'@'%' identified by 'Proper123';
flush privileges;
```

- 主库上锁表
```
flush tables with read lock;
```

- 查看binlog位置
```
mysql> show master status;
+---------------------+----------+--------------+------------------+-------------------+
| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------------+----------+--------------+------------------+-------------------+
| mysql-binlog.000004 |      583 |              |                  |                   |
+---------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
```

- 备份数据库
```
mysqldump -h 192.168.1.102 -P 33306 -p   --set-gtid-purged=OFF -A -B >master_$(date +%F).sql
```

### 在从库上执行 ###

- 连接从库
`mysql -h 192.168.1.101 -P 33306 -p`

- 导入主库备份的数据库文件
`source /root/master_2017-12-19.sql;`

- 连接主服务器（指定用户和binlog位置）
```
change master to master_host='192.168.1.102', master_port=33306, master_user='mylink', master_password='Proper123', master_log_file='mysql-binlog.000004', master_log_pos=583;
```

- 开起从库复制
`start slave;`

- 查看从库状态
`show slave status;`


## mongo集群 ##

- 配置副本集

```
#第一分片

docker exec -it ihos_mongo_official_rs1_1_1 bash
mongo

config = {"_id":"rs1","members":[{"_id":0,"host":"192.168.1.103:37011"},{"_id":1,"host":"192.168.1.102:37012"},{"_id":2,"host":"192.168.1.101:37013"}]}
rs.initiate(config)
```

```
#第二分片
docker exec -it ihos_mongo_official_rs2_1_1 bash
mongo

config = {"_id":"rs2","members":[{"_id":0,"host":"192.168.1.101:37021"},{"_id":1,"host":"192.168.1.102:37022"},{"_id":2,"host":"192.168.1.103:37023"}]}
rs.initiate(config)
```

```
#配置节点
docker exec -it ihos_mongo_official_cf1_1 bash
mongo

config = {"_id":"cf","members":[{"_id":0,"host":"192.168.1.101:37103"},{"_id":1,"host":"192.168.1.102:37102"},{"_id":2,"host":"192.168.1.103:37101"}]}
rs.initiate(config)
```

- 启动mongos服务器

三台集群服务器执行以下命令
```
cd /opt/docker/ihos/mongos/
docker-compose up -d
```
- mongos添加集群分片

```
docker exec -it mongos_mongo_official_router_1 bash
mongo

sh.addShard("rs1/192.168.1.103:37011,192.168.1.102:37012,192.168.1.101:37013")
sh.addShard("rs2/192.168.1.101:37021,192.168.1.102:37022,192.168.1.103:37023")
```

- 添加账号认证

```
docker exec -it mongos_mongo_official_router_1 bash
mongo

use admin
db.createUser({
      user: "admin",
      pwd: "123456",
      roles: [ { role: "root", db: "admin" } ]
    })

db.createUser({
      user: "ihos",
      pwd: "adfW8ZHr",
      roles: [ { role: "readWrite", db: "ihos" } ]
    })
```

- 在docker-compose配置文件里面增加mongodb-keyfile集群认证，例如mongos添加集群认证方法。

```
mongo_official_router:
  image: mongo:3.2.9
  volumes:
    - ./keyfile:/opt/keyfile
  ports:
    - "27017:27017"
  command: mongos --keyFile /opt/keyfile/mongodb-keyfile --configdb cf/192.168.1.103:37101,192.168.1.102:37102,192.168.1.101:37103

```

## 添加定时任务 ##

### 服务器01上添加 ###

```
#nginx日志切割
59 23 * * * /opt/task/cut_nginx_log.sh > /dev/null 2>&1

#自动判断容器启动
*/5 * * * * /opt/task/start_docker.sh >> /opt/task/log/start_docker.log

#删除30天之前的tomcat日志
00 12 * * * /opt/script/del_tomcat_log.sh > /dev/null 2>&1

#kettle自动统计
50 1 * * * /opt/kettle/statistics.sh
```

### 服务器02上添加 ###

```
#备份mysql数据库
00 04 * * * /data/backup/mysql/mysql_backup.sh

#备份mongo数据库
00 05 * * * /data/backup/mongo/mongo_backup.sh

#获取创建时间超过一天且仍处于未支付状态的挂号单
00 */5 * * * /opt/task/mongo/mongo_count_registration.sh

#zabbix 监控IO
*/1 * * * * /usr/bin/iostat -k -x -d 1 3 >/data/zabbix/iostat_output 2>&1

#导出ws_log
15 2 * * * /opt/backup/mongo/backup.sh

#导入ws_log
45 2 * * * /opt/backup/mongo/wsLogImp.sh
```

### 服务器03上添加 ###

```
#备份HIS Web Service nginx日志
10 1 * * * /opt/backup/nginx/backup.sh

#zabbix 监控IO
*/1 * * * * /usr/bin/iostat -k -x -d 1 3 >/data/zabbix/iostat_output 2>&1

#删除30天之前的tomcat日志
00 12 * * * /opt/script/del_tomcat_log.sh > /dev/null 2>&1
```

